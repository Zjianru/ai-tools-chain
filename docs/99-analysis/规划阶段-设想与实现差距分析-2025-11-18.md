# 规划阶段 — 设想与实现差距分析（2025-11-18）

| 属性 | 值 |
|------|-----|
| **分析日期** | 2025-11-18 |
| **版本** | v1.0 |
| **分析范围** | 规划工作坊、敏捷教练、多轮协作、澄清小会机制 |

---

## 📋 概述

本文档对比用户的**规划阶段设想**与**当前代码/文档实现**的差距，逐条列出尚未实现的功能、需要改进的地方，并标注优先级与估计工作量。

### 用户设想的核心要素
1. **敏捷教练** 作为主持人和唯一用户接口
2. **多轮研讨** 机制：角色发言 → 教练汇总 → 教练轮询异议 → 共识收敛
3. **主动搜索知识库** 而非先问用户
4. **澄清小会** 机制：用户 + 特定角色 + 教练（传声筒）
5. **两阶段输出**：规划草案（未达成共识）vs 规划案（已定稿 JSON）
6. **多版本管理** 与版本报告

---

## 🔍 详细差距清单

### 1️⃣ **敏捷教练 Agent 架构** ⚠️ 部分实现

| 设想 | 实现状态 | 细节 | 优先级 |
|------|--------|------|--------|
| **独立 CoachAgent 或 AgileCoach 类** | ❌ 未实现 | 目前 `PlanningAgent` + `PlanningMeetingAgent` 是分离的，但还没有一个显式的"Coach 编排器"来统筹多角色与用户交互 | 🔴 高 |
| **Coach 作为唯一对外接口** | ⚠️ 部分 | REPL 中 `/plan` 是唯一入口，但内部没有显式的 Coach orchestrator 将输入分配给各角色 | 🟡 中 |
| **Coach 维护会议状态与进度** | ❌ 未实现 | 目前状态管理在 `state.json.actors.planning/planning_meeting` 中，没有显式的"当前会议轮数、各角色发言状态、待轮询角色"等 Coach 级别的状态机 | 🔴 高 |

---

### 2️⃣ **多轮研讨与共识收敛机制** ⚠️ 初步实现

| 设想 | 实现状态 | 细节 | 优先级 |
|------|--------|------|--------|
| **Round 1：所有角色依次发言** | ⚠️ 部分 | `PlanningMeetingAgent` 第 1-14 行代码中调用 5 个角色模型，各自返回 verdict；但角色没有"依次听前面所有角色的发言摘要"作为输入 | 🟡 中 |
| **Coach 汇总简报** | ⚠️ 部分 | 代码 line 106–114 构建 `round1CoachSummary`，但只是角色名 + 状态 + 第一个原因的简单字符串拼接，不是结构化的"简报对象" | 🟡 中 |
| **轮询异议：Coach 询问各角色对简报的意见** | ✅ 基础实现 | 代码 line 119–155 实现了 Round 2，将 `previous_per_role_verdicts` + `coach_summary` 传给各角色再次评估 | ✅ |
| **多轮直到共识** | ⚠️ 上限固定 | 目前只有硬编码的 2 轮（Round 1 + Round 2），达成共识的判断逻辑缺失；设想中应该"多轮直到共识或识别出阻塞点" | 🔴 高 |
| **识别"阻塞点"并暂停** | ❌ 未实现 | 当前没有从多角色 verdicts 中识别"blocking_open_questions"或一致性冲突的逻辑 | 🔴 高 |

---

### 3️⃣ **角色主动搜索 vs 先问用户** ✅ 已落实

| 设想 | 实现状态 | 细节 | 优先级 |
|------|--------|------|--------|
| **AI 优先基于常识填补信息** | ✅ 已落实 | `planning.system.md` prompt 明确要求角色基于常识/repo 上下文补齐信息，并在 `open_questions/assumptions` 记录疑点；不强制多轮澄清问卷 | ✅ |
| **假设与疑问显式标记** | ✅ 已落实 | `planning.ai.json.assumptions[]` 和 `open_questions[]` 是 schema 正式字段，PlanReviewAgent 在其为空时会给 warning | ✅ |

---

### 4️⃣ **澄清小会与传声筒机制** ⚠️ 框架存在，逻辑缺失

| 设想 | 实现状态 | 细节 | 优先级 |
|------|--------|------|--------|
| **识别 blocking open_questions** | ⚠️ 部分 | `planning_meeting.json.per_role_verdicts[role].blocking_open_questions[]` schema 已定义，但代码中判断"哪些是 blocking"的逻辑缺失 | 🟡 中 |
| **小会触发条件** | ❌ 未实现 | 没有逻辑判断"是否需要停下来进行澄清小会"；目前的澄清都是"提前预防"而非"实时识别并触发" | 🔴 高 |
| **Coach 发起小会的交互流** | ⚠️ 部分 | `/plan` 命令中有"澄清小会"的提示文本（line 72/111 in `plan.mjs`），但实际交互流程不清晰 | 🟡 中 |
| **传声筒：Coach 代替角色询问** | ⚠️ 伪实现 | 代码中提示用户"可以与教练对话澄清"，但没有显式的"某个角色提出问题 → Coach 中转 → 用户回答"的三方对话机制 | 🔴 高 |
| **用户澄清后重新进入会议** | ❌ 未实现 | 澄清结果（用户回答）如何被纳入下一轮讨论、如何更新角色的输入没有明确实现 | 🔴 高 |
| **信息足够判断** | ⚠️ 缺少协议 | Coach 如何判断"澄清足够，可以继续"没有明确的终止条件或协议 | 🟡 中 |

---

### 5️⃣ **两阶段输出：规划草案 vs 规划案** ⚠️ 文档清晰，代码混淆

| 设想 | 实现状态 | 细节 | 优先级 |
|------|--------|------|--------|
| **规划草案（文字，未达共识）** | ⚠️ 部分 | 代码中有 `planning.draft.json`，但语义模糊；设想中应该明确"在多轮中途或无法共识时的输出物" | 🟡 中 |
| **规划案（JSON，已定稿）** | ✅ 已实现 | `planning.ai.json` 符合 schema，可传递给下游 codegen | ✅ |
| **两者的区别标记** | ❌ 未实现 | 没有显式字段标记"本文件是草案还是定稿" | 🟡 中 |
| **草案不可用于 codegen 的警告** | ❌ 未实现 | 当 `planning.meeting.json.decision === "hold"` 或未达成共识时，应该明确警告"不能生成代码"；目前没有这样的拦截机制 | 🟡 中 |

---

### 6️⃣ **多版本管理与版本报告** ⚠️ 框架存在，逻辑不完整

| 设想 | 实现状态 | 细节 | 优先级 |
|------|--------|------|--------|
| **版本快照：`versions/v1/v2/...`** | ✅ 基础实现 | `src/planning/versions.mjs` 有 `snapshotPlanningVersion()` 函数；`PlanningMeetingAgent` 调用它做快照 | ✅ |
| **版本报告目录** | ⚠️ 部分 | `tasks/<id>/reports/planning/v<round>/planning.report.md` 和 `latest/` 已在代码中生成，但整个目录结构与版本管理的完整性还需评审 | 🟡 中 |
| **用户拿上一版报告 + 意见重新 /plan** | ⚠️ 部分 | `PlanningAgent` 代码已尝试读取 `latest/planning.report.md`，但没有明确的"version selector"或"diff viewer"让用户对比不同版本 | 🟡 中 |
| **新版本与旧版本的关联** | ❌ 未实现 | 没有"v2 基于 v1 + 用户反馈"的显式记录；版本间的演进关系缺失 | 🟡 中 |
| **草案版本 vs 定稿版本** | ❌ 未实现 | 版本的状态（draft/done）没有显式标记；目前每版都假设是"当前版"，没有"草案"状态的概念 | 🔴 高 |

---

### 7️⃣ **REPL 与流程集成** ⚠️ 框架存在，细节缺失

| 设想 | 实现状态 | 细节 | 优先级 |
|------|--------|------|--------|
| **`/plan <brief>` 作为唯一入口** | ✅ 已实现 | `/plan` 命令存在且作为规划入口 | ✅ |
| **多轮会议中的中间反馈** | ⚠️ 缺失 | 用户在会议进行中如何跟 Coach 互动、如何选择"继续/暂停/澄清"的 REPL 命令流程缺失 | 🔴 高 |
| **澄清交互的 REPL 支持** | ❌ 未实现 | 当需要"澄清小会"时，REPL 应该进入一个特殊的"问答模式"，目前没有 | 🔴 高 |
| **多版本查看与比较** | ❌ 未实现 | 没有 `/plan-versions` 或类似命令查看历史版本列表与 diff | 🟡 中 |
| **显式进度指示** | ⚠️ 缺失 | 当进行多轮会议时，应该明确提示"当前第 N 轮，共计 M 轮"或"等待某个角色回答"，目前没有 | 🟡 中 |

---

### 8️⃣ **规划报告的生成与呈现** ⚠️ 部分实现

| 设想 | 实现状态 | 细节 | 优先级 |
|------|--------|------|--------|
| **面向用户的规划总结** | ✅ 基础实现 | `planning.meeting.md` 和 `planning.report.md` 由代码生成 | ✅ |
| **报告内容：共识/决策/假设/未决** | ✅ 基础实现 | `buildPlanningReport()` 包含这些内容 | ✅ |
| **报告的易读性与完整性** | ⚠️ 需改进 | 报告应该明确展示"多轮讨论过程"、"各角色观点汇总"、"关键分歧点"，目前比较简略 | 🟡 中 |
| **草案报告 vs 定稿报告** | ❌ 未实现 | 没有区分"本次是草案还是定稿"；草案应该明显标记"需用户反馈"或"未准备好下发 codegen" | 🟡 中 |

---

## 📊 优先级统计

### 🔴 高优先级（需立即实现或重设计）— 11 项

1. **独立 CoachAgent 或 Coach 编排器** — 当前 Planning + PlanningMeeting 虽分离，但没有显式的 Coach 状态机
2. **Coach 维护会议状态** — 需要追踪当前轮数、各角色发言状态、待轮询列表
3. **多轮直到共识** — 目前硬编码 2 轮，需要动态判断何时达成共识
4. **识别阻塞点** — 从多角色 verdicts 中识别 blocking_open_questions 和冲突
5. **小会触发条件** — 需要逻辑判断"是否需要停下来澄清"
6. **传声筒机制** — Coach 代替特定角色与用户对话的三方机制
7. **澄清结果纳入下轮** — 用户澄清后，结果如何被纳入下一轮讨论
8. **多轮会议中的 REPL 交互** — 用户在会议进行中的选择与命令流程
9. **澄清交互的 REPL 模式** — 进入澄清问答模式的命令与交互
10. **规划草案 vs 定稿的状态标记** — 显式区分两者
11. **草案不可用的拦截** — 当状态为"hold"或"draft"时，拦截 `/codegen`

---

### 🟡 中优先级（需改进或优化）— 14 项

1. **Coach 作为唯一对外接口** — 增强 REPL 中的 Coach 角色感
2. **Round 1 角色需接收前面所有角色的发言摘要** — 目前发言顺序无法保证
3. **Coach 汇总简报结构化** — 从简单字符串升级为结构化对象
4. **识别 blocking_open_questions** — schema 已定义，逻辑待实现
5. **Coach 小会的交互流清晰度** — 提示文本存在但流程不清晰
6. **版本报告目录完整性评审** — 目前生成但结构可能不够清晰
7. **用户对比版本的工具** — 缺少 `/plan-versions` 等命令
8. **多版本进度指示** — "第 N 轮"的明确提示
9. **规划报告的多轮过程展示** — 应该更清晰地呈现讨论过程
10. **版本间的显式关联** — v2 基于 v1 + 反馈的记录
11. **新版本与旧版本的关联** — 记录版本演进关系
12. **两者的区别标记** — 规划草案 vs 规划案的标记字段
13. **版本的状态标记** — draft/hold/done 的显式状态
14. **两阶段输出的文档清晰度** — 代码中 `planning.draft.json` 语义模糊

---

### ✅ 已实现或基本实现 — 6 项

1. **独立 PlanningAgent** ✅
2. **独立 PlanningMeetingAgent** ✅
3. **AI 优先基于常识填补信息** ✅
4. **假设与疑问显式标记** ✅
5. **规划案（JSON 定稿）** ✅
6. **版本快照框架** ✅

---

## 🎯 建议实现路线

### **Phase A（M11 短期，1–2 周）— 完善核心多轮机制**

**目标**：让规划工作坊的"多轮研讨 + 共识收敛"真正可用。

**任务**：

1. **新增 `CoachOrchestrator` 类** （或在 PlanningMeetingAgent 内增强）
   - 维护显式的会议状态机：当前轮数、各角色发言状态、共识判断
   - 实现 `convergeConsensus(perRoleVerdicts: Map) → { converged: bool, blockingIssues: [], nextAction }`
   - 返回值指导"继续第 N+1 轮、停止澄清、或转向用户澄清"

2. **改进多轮逻辑**
   - 替代硬编码的 2 轮，改为动态判断：`while (!converged && round < MAX_ROUNDS)` 
   - 在每轮后检查：所有角色 ok=true？主要分歧是否存在？
   - 上限建议为 3–4 轮（超过则转向用户澄清）

3. **识别 blocking_open_questions**
   - 遍历多角色 `blocking_open_questions[]`，聚合为"Coach 需要向用户澄清的关键问题列表"
   - 如存在 blocking 问题，状态转为"awaiting_clarification"

4. **标记草案 vs 定稿**
   - 在 `planning.ai.json` 顶层增加 `draft_status: "draft" | "pending" | "finalized"`
   - 在 `planning.meeting.json` 中增加 `meeting.converged: boolean` 与 `meeting.blocking_issues: []`
   - 当 `converged=false` 且轮次已尽时，输出为"规划草案"，在报告中明确标记

**代码目标**：
- 文件：`src/planning/coachOrchestrator.mjs`（新建）
- 修改：`src/agents/planningMeetingAgent.mjs`（调用 CoachOrchestrator）
- 修改：`src/planning/planningMeetingCore.mjs`（生成报告时标记状态）

---

### **Phase B（M11 中期，2–3 周）— 澄清小会与传声筒**

**目标**：实现"Coach 中转用户与角色的问答"机制。

**任务**：

1. **澄清小会的 REPL 交互模式**
   - 当 Coach 识别到 blocking_questions 时，生成交互文本
   - 进入"澄清问答模式"（可选：新 REPL 状态或独立子交互）
   - 格式化呈现各个 blocking 问题给用户，支持逐条回答
   - 将用户回答存储到 `tasks/<id>/planning/clarifications.jsonl`

2. **传声筒机制**
   - 记录"问题来自哪个角色"、"用户的回答"、"回答时间"
   - 将澄清结果注入为"Round N+1"的输入
   - 所有角色在 Round N+1 中接收到：`clarifications: [{ from_role, question, user_answer, timestamp }]`

3. **澄清结束判断**
   - 当用户完成一轮澄清后，由 Coach（或模型）判断"是否信息足够继续"
   - 提示选项："好的，基于澄清重新开会" / "还有其他问题吗"

4. **澄清后重新进入会议**
   - 第 N+1 轮从 `planning_meeting_clarification_round` 重新启动
   - 各角色在新输入（含澄清）基础上重新给 verdict
   - 回到"共识收敛"判断

**代码目标**：
- 新文件：`src/cli/commands/clarify.mjs`（澄清问答处理）
- 修改：`src/cli/repl.mjs`（在适当时刻调用澄清交互）
- 修改：`src/planning/transcript.mjs`（记录澄清结果）
- 修改：`src/agents/planningMeetingAgent.mjs`（将澄清纳入下轮输入）

---

### **Phase C（M11 长期，1–2 周）— 版本管理与报告完善**

**目标**：让多版本规划有清晰的呈现与比较能力。

**任务**：

1. **版本状态管理**
   - `planning.meeting.json` 新增 `version_info: { round: N, status: "draft"|"finalized", created_at, updated_at }`
   - 在 `versions/vN/` 中保存完整的 round 元数据

2. **版本演进记录**
   - `versions/vN/evolution.json`：记录"本版本基于 vN-1 + 用户反馈的变化点"
   - 便于用户理解"为什么这一版不同"

3. **多版本查看命令** 🔵 可选
   - `/plan-versions`：列出所有版本与摘要
   - `/plan-diff v1 v2`：对比两个版本的差异

4. **规划报告的改进**
   - 报告标题明确标记"第 N 版"与"状态（草案/定稿）"
   - 新增"多轮讨论摘要"部分，展示 Round 1 → Round N 的演进
   - 显式列出"关键假设"、"未决问题"、"与前一版的变化"

**代码目标**：
- 修改：`src/planning/versions.mjs`（增强版本元数据）
- 修改：`src/planning/planningMeetingCore.mjs` → `buildPlanningReport()`（改进报告生成）
- 可选新文件：`src/cli/commands/plan-versions.mjs`

---

### **Phase D（M11 最后阶段或 M12，1 周）— 拆分独立角色 Agent**

**目标**：从当前的"模型调用"升级为"独立 Agent"（可选 M12）。

**说明**：当前通过 `invokeRole()` 调用各角色。如果要支持更细的"交互式澄清"、"角色间协作"，可以拆成独立 Agent：

- `ProductPlannerAgent`
- `SystemDesignerAgent`
- `SeniorDeveloperAgent`
- `TestPlannerAgent`
- `RiskPlannerAgent`

每个 Agent 自己维护状态，通过 Coach 编排。此项可推迟到 M12。

---

## 📝 检查清单

以下清单可用于验收实现的完整性：

- [ ] **CoachOrchestrator / Coach 编排器** 实现并集成
- [ ] **动态多轮直到共识** 的逻辑实现
- [ ] **识别 blocking_open_questions** 并标记
- [ ] **规划草案 vs 定稿** 的状态标记
- [ ] **草案拦截** — `/codegen` 在 draft 状态下提示或拦截
- [ ] **澄清小会** REPL 交互模式
- [ ] **传声筒机制** — 问题关联、澄清纳入下轮
- [ ] **版本演进记录** — v2 基于 v1 的变化
- [ ] **改进的规划报告** — 包含多轮摘要与状态标记
- [ ] **测试覆盖** — 单测覆盖新增的 Coach 逻辑与共识收敛判断
- [ ] **文档更新** — 同步最新的实现到 `planning-workshop-design.md`

---

## 📚 关联文档

- `docs/02-architecture/10-planning-workshop-design.md` — 总纲（单一真相来源）
- `docs/02-architecture/12-planning-evolution-multi-agent.md` — 多版本设计
- `docs/02-architecture/13-planning-multi-agent-roles-io.md` — 角色 I/O 协议
- `docs/04-agents/02-agents-todo-midterm.md` — Agent 中期 TODO

---

## 🎓 总结

**已实现的坚实基础：**
- ✅ 模型调用、多角色 verdict、基础 2 轮轮询
- ✅ 版本快照框架、规划报告生成
- ✅ AI 优先基于常识、假设与问题的显式记录

**关键缺口（需立即弥补）：**
1. ❌ **动态共识收敛逻辑** — 当前只有硬编码 2 轮
2. ❌ **澄清小会与传声筒** — 框架存在，核心流程缺失
3. ❌ **草案 vs 定稿的清晰标记与拦截** — 没有状态区分
4. ❌ **多轮会议中的 REPL 交互** — 用户在会议中的参与度不足

**建议优先完成 Phase A（共识收敛 + 状态标记），再逐步迭代 Phase B–D。**

