# 规划工作坊 - 多轮渐进共识模型设计文档

> 本文档记录了规划阶段（Planning Phase）的核心设计：多 AI 角色协作、多轮共识构建、用户澄清反馈机制。  
> 作者对话：Zjianru ↔ Copilot  
> 日期：2025-11-18

---

## 1. 角色定义

### 1.1 敏捷教练（Agile Coach）
**职责**：
- 会议主持人 + 协调者 + 记录者 + 传声筒
- 召集各角色参会
- 判断信息充分性
- 需要用户澄清时，代替提问的 AI 角色与用户对话（自然语言，不限轮次）
- 记录每轮共识
- 标记每轮的"新问题点"（上轮未解决 或 新产生的）
- 最终汇总所有角色意见 → 生成规划报告

### 1.2 五大专业 AI 角色

| 角色 | 专业领域 | 核心关注 |
|------|--------|--------|
| **ProductPlanner** | 业务 | 需求理解、scope、non_goals、acceptance criteria |
| **SystemDesigner** | 系统设计 | 架构、模块拆分、技术方案、file_impacts |
| **SeniorDeveloper** | 实现复杂度 | 工作量、技术债、风险点、可行性评估 |
| **TestPlanner** | 质量保证 | 测试策略、用例设计、coverage 目标 |
| **RiskPlanner** | 风险管理 | 风险识别、缓解方案、依赖项、假设 |

---

## 2. 工作坊流程（完整版本）

### 2.1 核心流程（统一的循环模型）

```
用户输入：/plan "需求描述" [+ 可选：前版规划报告 + 用户反馈意见]
    ↓
【初始化】
共识草案 = {}  # 前轮达成的共识
本轮问题清单 = {用户需求的所有内容}
轮次 = 1
    ↓
╔════════════════════════════════════════════════════════════╗
║           【多轮讨论循环】（行为模式统一）                 ║
║   每轮的步骤相同，只是关注的问题不同                        ║
║   问题清单越讨论越少、越讨论越精细                          ║
╚════════════════════════════════════════════════════════════╝
    ↓
【第N轮：5个 AI 角色顺序思考、发言】

  ┌─ ProductPlanner 思考并发言 ────────────────┐
  │ 输入：                                      │
  │   • 用户需求                                │
  │   • 共识草案（第1轮为空）                   │
  │   • 本轮问题清单                            │
  │   • ProductPlanner 的 system prompt         │
  │ 行为：                                      │
  │   • 围绕"本轮问题清单"展开分析              │
  │   • 可主动搜索知识库、向大模型提问          │
  │   • 识别新的问题或不确定的地方              │
  │ 输出：                                      │
  │   • 业务分析、建议                          │
  │   • 待澄清的问题（如有）                    │
  │   • 新的问题发现（如有）                    │
  │ 记录：PP_speak_r{轮}.txt                    │
  └─────────────────────────────────────────────┘
        [可能触发用户澄清对话]
    ↓
  ┌─ SystemDesigner 思考并发言 ─────────────────┐
  │ 输入：                                       │
  │   • 用户需求                                 │
  │   • 共识草案（第1轮为空）                    │
  │   • 本轮问题清单                             │
  │   • PP 在本轮的发言（完整记录）              │
  │   • SystemDesigner 的 system prompt          │
  │ 行为：                                       │
  │   • 围绕"本轮问题清单"+ PP 的意见展开分析   │
  │   • 结合 PP 的观点，从系统设计角度补充、深化 │
  │   • 可主动搜索知识库、向大模型提问           │
  │   • 识别新的问题或不确定的地方               │
  │ 输出：                                       │
  │   • 系统设计分析、建议                       │
  │   • 对 PP 的补充/修正意见（如有）            │
  │   • 待澄清的问题（如有）                     │
  │   • 新的问题发现（如有）                     │
  │ 记录：SD_speak_r{轮}.txt                     │
  └──────────────────────────────────────────────┘
        [可能触发用户澄清对话]
    ↓
  ┌─ SeniorDeveloper 思考并发言 ────────────────┐
  │ 输入：                                       │
  │   • 用户需求                                 │
  │   • 共识草案（第1轮为空）                    │
  │   • 本轮问题清单                             │
  │   • PP + SD 在本轮的完整发言记录              │
  │   • SeniorDeveloper 的 system prompt         │
  │ 行为：                                       │
  │   • 围绕"本轮问题清单"+ 前面两位的意见展开   │
  │   • 从实现复杂度角度补充、深化、质疑（if需要） │
  │   • 可主动搜索知识库、向大模型提问           │
  │   • 识别新的问题或不确定的地方               │
  │ 输出：                                       │
  │   • 实现复杂度评估、建议                     │
  │   • 对前面意见的补充/修正（如有）            │
  │   • 待澄清的问题（如有）                     │
  │   • 新的问题发现（如有）                     │
  │ 记录：Dev_speak_r{轮}.txt                    │
  └──────────────────────────────────────────────┘
        [可能触发用户澄清对话]
    ↓
  ┌─ TestPlanner 思考并发言 ────────────────────┐
  │ 输入：                                       │
  │   • 用户需求                                 │
  │   • 共识草案（第1轮为空）                    │
  │   • 本轮问题清单                             │
  │   • PP + SD + Dev 在本轮的完整发言记录        │
  │   • TestPlanner 的 system prompt             │
  │ 行为：                                       │
  │   • 围绕"本轮问题清单"+ 前面三位的意见展开   │
  │   • 从测试/质量角度补充、深化、质疑（if需要） │
  │   • 可主动搜索知识库、向大模型提问           │
  │   • 识别新的问题或不确定的地方               │
  │ 输出：                                       │
  │   • 测试策略、建议                           │
  │   • 对前面意见的补充/修正（如有）            │
  │   • 待澄清的问题（如有）                     │
  │   • 新的问题发现（如有）                     │
  │ 记录：TP_speak_r{轮}.txt                     │
  └──────────────────────────────────────────────┘
        [可能触发用户澄清对话]
    ↓
  ┌─ RiskPlanner 思考并发言 ────────────────────┐
  │ 输入：                                       │
  │   • 用户需求                                 │
  │   • 共识草案（第1轮为空）                    │
  │   • 本轮问题清单                             │
  │   • PP + SD + Dev + TP 在本轮的完整发言记录   │
  │   • RiskPlanner 的 system prompt             │
  │ 行为：                                       │
  │   • 围绕"本轮问题清单"+ 前面所有的意见展开   │
  │   • 从风险管理角度补充、深化、质疑（if需要） │
  │   • 可主动搜索知识库、向大模型提问           │
  │   • 识别新的问题或不确定的地方               │
  │ 输出：                                       │
  │   • 风险评估、建议                           │
  │   • 对前面意见的补充/修正（如有）            │
  │   • 待澄清的问题（如有）                     │
  │   • 新的问题发现（如有）                     │
  │ 记录：RP_speak_r{轮}.txt                     │
  └──────────────────────────────────────────────┘
        [可能触发用户澄清对话]
    ↓
【本轮讨论完成】
敏捷教练汇总本轮发言：
  • 从各角色发言中提取共识部分 → 加入"共识草案"
  • 提取新的问题发现 → 列入"本轮新问题清单"
  • 敏捷教练督促各角色：
    - 不偏离主题
    - 避免过度讨论（深度适度即可）
    - 保持focus
    ↓
是否还有未解决的问题？
  ├─ 有 → 本轮问题清单 = 新问题清单 → 轮次 += 1 → 回到【第N轮】
  │       （第2轮的输入已经包含了第1轮的共识和新问题）
  │       （问题越讨论越少，讨论越精细）
  └─ 无 → 进入【最终输出】
    ↓
【最终输出】
各 AI 角色输出最终文档：
  • ProductPlanner → product_plan.json
  • SystemDesigner → system_design.json
  • SeniorDeveloper → dev_plan.json
  • TestPlanner → test_plan.json
  • RiskPlanner → risk_assessment.json
    ↓
敏捷教练汇总 + 生成规划报告：
  • planning_report.md（人类可读）
  • planning.ai.json（结构化）
  • planning_transcript.jsonl（完整对话记录）
    ↓
产出放置：.ai-tools-chain/planning_outputs/v{version_number}/
```

---

## 3. 核心概念精细化

### 3.1 统一的讨论循环模式

**关键认识**：不存在"发言阶段"和"询问阶段"的区分。整个过程就是**一种行为模式的重复**：

✅ **每轮的行为完全相同**：5个角色顺序思考、发言  
✅ **每轮的关注点不同**：问题清单不断精细化、缩小  
✅ **每轮的基础不同**：共识草案不断充实、补全  

**第1轮**：
- 共识草案 = 空（没有前轮共识）
- 问题清单 = 用户的完整需求
- 5个角色顺序发言，各自从自己的专业领域分析

**第2轮**：
- 共识草案 = 第1轮中各角色已达成共识的部分
- 问题清单 = 第1轮产生的新问题 + 未解决的问题（更精细化）
- 5个角色再次顺序发言，每个都基于"问题清单"深化分析

**第N轮**：
- 问题越讨论越少（已解决的从问题清单移出）
- 问题越讨论越精细（粗问题被细化成具体问题）
- 直到问题清单为空 = 讨论完成

### 3.2 "共识草案" 的作用

**共识草案** = 各轮讨论中逐步确认、各角色已达成一致的部分

- 第1轮：空
- 第2轮之后：包含第1轮中各角色共同认可的内容
- 作用：为后续轮次的讨论**提供稳定的基础**，避免重复讨论

**谁来决定什么进入"共识草案"？**  
敏捷教练在汇总各角色发言时，判断哪些内容已经"没有异议"，将其纳入共识草案。

### 3.3 "问题清单" 的演变

**第1轮问题清单** = 用户需求的完整内容

**第N轮问题清单** = 第N-1轮产生的新问题 + 尚未达成共识的旧问题

**"问题消失"的两种情况**：
1. 被讨论到足够清楚 → 进入"共识草案"
2. 被后续讨论发现是"伪问题"或已被其他问题包含

### 3.4 角色发言时的"思考输入"结构（精确版本）

当某个角色在第N轮发言时：

```
【稳定背景】
• 用户的原始需求
• 该角色的 system prompt（定义其专业领域 + 职责）

【前轮共识】
• 共识草案（来自第1到N-1轮）
• 这部分是"已确定的背景"，无需重新讨论

【当前问题清单】
• 第N轮需要集中讨论的问题清单
• 这是本轮的"主要聚焦"

【前面 AI 角色的本轮发言】
• ProductPlanner 的本轮发言 (if 该角色 != PP)
• SystemDesigner 的本轮发言 (if 该角色 != SD)
• ...
• 上一个角色的本轮发言

【任务】
围绕"当前问题清单"展开分析，结合：
  • 前轮共识（已知部分）
  • 前面角色的本轮意见（参考与补充）
  • 自己的专业知识（搜索知识库、向大模型提问）
输出：
  • 从本角色专业领域的分析结果
  • 对前面角色意见的补充/修正（如有）
  • 新发现的问题或不确定的地方
```

### 3.5 "用户澄清" 的完整处理流程

**何时触发用户澄清**：
- 某个 AI 角色在发言中提出了"需要用户澄清才能继续分析"的问题
- 例如：「这个需求是否涉及数据迁移？」

**处理流程**：

```
【某 AI 角色在发言中提出澄清问题】
    ↓
敏捷教练评估：这个问题是否真的需要用户澄清？
  ├─ 不确定 → 作为"传声筒"与用户对话
  │   敏捷教练不替代 AI 角色判断，只是中立地传达
  │   用户回答后，记录澄清内容
  └─ 确定需要 → 直接与用户对话（代替该 AI 角色）
    ↓
【用户澄清对话】
敏捷教练与用户进行自然语言交互：
  • 多轮对话（直到澄清充分）
  • 敏捷教练督促对话不偏离主题
  • 记录澄清结果
    ↓
【澄清后继续】
敏捷教练将澄清内容纳入本轮问题清单：
  • 该澄清内容可能简化某些问题（问题消失）
  • 也可能产生新的问题（问题数量增加，但更具体）
    ↓
继续本轮的 AI 发言流程
  • 澄清后的下一个 AI 角色将澄清内容作为"新背景"继续发言
  • 之后的 AI 角色也都纳入这个澄清内容
```

**关键点**：
- 用户澄清**不计入轮次**（可以任意多轮澄清）
- 敏捷教练是中立的"传声筒"，尤其是在**不能完全确定**是否需要澄清时
- 敏捷教练的职责是**记录、调停、拉人开会**，而不是替代 AI 或用户做判断

### 3.6 敏捷教练的职责边界

**敏捷教练做**：
✅ 记录每个 AI 的发言  
✅ 提取共识部分 → 维护"共识草案"  
✅ 提取新问题 → 更新"问题清单"  
✅ 代替需要澄清的 AI 角色与用户对话  
✅ 督促 AI 不偏离主题、避免过度讨论  
✅ 汇总最终结果  

**敏捷教练不做**：
❌ 替 AI 做专业判断  
❌ 替用户做决策  
❌ 决定什么进入"共识草案"（基于客观的一致性）  

---

## 4. 数据结构与持久化

### 4.1 会议记录格式

```jsonl
# planning_transcript.jsonl（每行一个 JSON 对象）

{"ts": "2025-11-18T10:30:00Z", "round": 1, "phase": "user_input", "actor": "user", "content": "我需要为项目增加..."}
{"ts": "2025-11-18T10:31:00Z", "round": 1, "phase": "coach_initial_judgment", "actor": "coach", "info": "信息充分，开始第1轮发言"}
{"ts": "2025-11-18T10:32:00Z", "round": 1, "phase": "speaking", "actor": "ProductPlanner", "turn": 1, "input_context": {...}, "output": "..."}
{"ts": "2025-11-18T10:33:00Z", "round": 1, "phase": "speaking", "actor": "SystemDesigner", "turn": 2, "input_context": {...}, "output": "..."}
...
{"ts": "2025-11-18T10:40:00Z", "round": 1, "phase": "user_clarification_needed", "actor": "SystemDesigner", "issue": "需要用户澄清..."}
{"ts": "2025-11-18T10:41:00Z", "round": 1, "phase": "user_clarification_dialogue", "actor": "coach", "question": "代替 SystemDesigner 提问...", "user_reply": "..."}
{"ts": "2025-11-18T10:45:00Z", "round": 1, "phase": "consensus_summary", "actor": "coach", "consensus": {...}, "new_issues": [...]}
...
```

### 4.2 版本管理结构

```
.ai-tools-chain/
  planning_outputs/
    v1/
      planning_report.md          # 敏捷教练最终汇总
      planning.ai.json            # 结构化数据
      planning_transcript.jsonl   # 完整对话记录
      product_plan.json           # ProductPlanner 输出
      system_design.json          # SystemDesigner 输出
      dev_plan.json               # SeniorDeveloper 输出
      test_plan.json              # TestPlanner 输出
      risk_assessment.json        # RiskPlanner 输出
    v2/
      （用户对 v1 不满意，加入反馈重新 /plan 生成）
    v3/
      ...
```

---

## 5. 关键设计原则

1. **行为模式统一**  
   每轮的步骤完全相同：5个角色顺序思考、发言。不存在"阶段"的划分。

2. **问题清单是递减且精细化的**  
   不试图一轮解决所有问题，而是逐轮筛选、深化。问题越讨论越少（已解决的移出）、越讨论越精细。

3. **共识是递增的**  
   共识草案逐轮充实，一旦纳入就不再反复讨论，为后续轮次的讨论奠定稳定基础。

4. **角色有序发言，带上前面意见**  
   后发言的角色能看到前面角色的观点，保证逻辑连贯性和补充的有效性。

5. **用户澄清不计入轮次**  
   只要需要就澄清，自然语言交互，直到信息充分。多轮澄清也没问题。

6. **敏捷教练是中立的传声筒与调停者**  
   - 记录所有发言
   - 在无法确定时，不替代 AI 或用户判断，只是中立传达
   - 代替需要澄清的 AI 与用户对话
   - 督促对话不偏离主题、不过度讨论
   - 汇总最终结果

7. **知识库优先于提问用户**  
   AI 角色先自己搜索知识库、向大模型提问，必要时才提出用户澄清。

8. **敏捷教练须防止讨论偏离或过度深入**  
   这是设计上的重要约束——确保讨论聚焦、高效、有深度但不过度。

---

## 6. 与现有代码的关系

### 当前代码中已有的部分：
- `PlanningAgent`：对应敏捷教练的一部分（但逻辑还需完善）
- 五个 Role Handler（deepseek/planning*.mjs）：对应五个专业角色
- `planningMeetingCore.mjs`：一些基础的多角色协调逻辑

### 需要重构/新增的部分：
- 敏捷教练的**完整逻辑**：判断信息充分性、管理共识记录、标记新问题点、处理用户澄清对话
- **轮次管理**：明确的"发言阶段"和"询问阶段"的分离
- **问题点追踪**：显式维护"本轮新问题点"的列表
- **用户澄清子流程**：暂停-对话-继续的完整机制

---

## 7. 三个关键设计决策（设计共识 2025-11-18）

### 决策1：多轮对话的行为模式统一

❌ **错误理解**（之前）：区分"发言阶段"和"询问阶段"  
✅ **正确理解**（已纠正）：每轮的行为完全相同——5个角色顺序思考、发言

**含义**：
- 第1轮：5个角色发言，输入是用户需求 + 空共识
- 第2轮：5个角色再次发言，输入是用户需求 + 第1轮共识 + 新问题清单
- 第N轮：重复相同模式，每轮的关注点（问题清单）不同

**好处**：
- 逻辑清晰，易于实现
- 每轮的流程完全可复用
- 问题自然地越讨论越精细

---

### 决策2：敏捷教练的判断边界

❌ **错误理解**（之前）：敏捷教练有"强大的判断能力"决定是否需要用户澄清  
✅ **正确理解**（已纠正）：敏捷教练是中立的"传声筒"

**含义**：
- 当无法判断是否需要用户澄清时 → 作为传声筒，代替提问的 AI 与用户对话
- 这是一场"小会"：敏捷教练拉上用户和提问问题的 AI 角色
- 敏捷教练负责记录、调停、确保不偏离主题

**好处**：
- 不强加敏捷教练的判断
- 让具有专业知识的 AI 通过"间接对话"与用户交流
- 敏捷教练专注于协调和记录，职责单一

---

### 决策3：问题清单的演变与共识的积累

❌ **错误理解**（之前）：存在"发言"和"询问"两种不同的步骤  
✅ **正确理解**（已纠正）：只有一种步骤，问题清单是递减且精细化的

**含义**：
- 问题不是一轮"问询"就消失的，而是通过多轮讨论逐步被纳入共识
- 每轮讨论后，敏捷教练提取"已无异议"的部分 → 纳入共识草案
- 剩余未解决的问题 → 下一轮的问题清单（更精细化）

**好处**：
- 共识是客观的（基于各角色发言的一致性），不是武断决定
- 问题清单的演变过程可追踪
- 讨论自然收敛（问题最终清单为空 = 讨论完成）

---

## 8. 下一步行动

1. ✅ 敲定设计（本文档）
2. ⏳ 编写敏捷教练的 Agent 核心逻辑
3. ⏳ 重构五个角色的 Role Handler，适配新的输入结构
4. ⏳ 实现轮次管理和问题清单追踪
5. ⏳ 测试多轮对话的完整流程
6. ⏳ 集成用户澄清子流程

