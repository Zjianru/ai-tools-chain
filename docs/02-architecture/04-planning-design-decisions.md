# 规划阶段设计决策记录 - 2025-11-18

| 属性 | 值 |
|------|-----|
| **最后更新** | 2025-11-18 |
| **版本** | v1.0 |
| **状态** | ✅ Current |

---

## 📝 更新历史

- **2025-11-18**: 初稿完成

---

**时间**：2025-11-18  
**决策者**：@user  
**决策状态**：✅ 已确认  
**影响范围**：M11-3 及后续实现

---

## 一、讨论轮次策略

### ✅ 决策1：快速路径 - Round 1 全同意即产出规划案

**原文**：
> 如果 round1 就同意，那就太好了啊，我们直接就能产出规划案了，后面的讨论也就不用再进行了

**含义**：
```
Round 1 结束后：
  ├─ 所有 5 个角色都同意（ok === true）→ 直接生成规划案 (planning.ai.json)
  │                                    ↓
  │                              进入 codegen 阶段
  │
  └─ 有任何角色不同意或保留 → 进入 Round 2
                        ↓
                   Round 2 结束后
                        ↓
                   无论是否同意 → 启动小会（澄清）
                        ↓
                   Round 3 讨论
                        ↓
                   生成规划案或草案
```

**代码影响**：
- 修改 `planningMeetingAgent.mjs` 中的决策逻辑
- Round 1 后添加"全同意"的快速路径检查
- 仅当存在 `concern` 或 `block` 时才启动 Round 2

**相关文件**：`src/agents/planningMeetingAgent.mjs` (L100+)

---

## 二、Round 3 的精确输入结构

### ✅ 决策2：Round 3 各角色的输入清单

**原文**：
> 此时每个 AI 的输入，就变成了：
> - 用户原始需求
> - 前两轮的共识
> - 当前轮要澄清的问题
> - 用户对要澄清问题的回答
> - 当前轮前面 AI 们的回答
> - 每个 AI 自己的 prompt

**含义**：
```
Round 3 的每个角色的 payload：

{
  "user_brief": "用户原始需求",
  "consensus_from_r1_r2": {
    "agreed_points": [...],        // 前两轮达成共识的点
    "conflicting_points": [...]    // 前两轮仍有分歧的点
  },
  "clarification_questions": {
    "question_1": "系统是否要与现有用户系统绑定？",
    "question_2": "数据迁移是否在 scope 内？",
    ...
  },
  "user_answers": {
    "question_1": "是的，需要绑定",
    "question_2": "不在这次 scope 内"
  },
  "previous_ai_responses_in_r3": {
    "ProductPlanner": { ok, reasons, ... },  // Round 3 中已发言的角色结论
    "SystemDesigner": { ok, reasons, ... }
  },
  "my_prompt": "你作为 TestPlanner 的角色 prompt..."
}
```

**关键点**：
- `consensus_from_r1_r2` 是明确的、双方都认可的共识
- 小会中的澄清 Q&A 以 dict 形式组织，便于 AI 理解对应关系
- `previous_ai_responses_in_r3` 确保后发言的角色能看到前面角色的新判断

**代码影响**：
- 修改 `planningMeetingCore.mjs` 中的 payload 构建逻辑
- 需要显式地从 Round 1/2 的讨论中提取"已共识"部分
- 澄清 Q&A 需要结构化存储（不仅仅是 transcript）

**相关文件**：`src/agents/planningMeetingAgent.mjs` (L130+), `src/planning/planningMeetingCore.mjs` (L60+)

---

## 三、草案使用的风险处理

### ✅ 决策3：系统记录而非阻止，用户自负其责

**原文**：
> 系统记录就行了，没必要制止，他想生成那就让他生成去，反正我们后面代码生成的时候也是有日志的，会记录用于输入给代码生成器的原始输入，真出了问题也可以追根溯源

**含义**：
```
用户试图用规划草案（planning.draft.md）进行 codegen：

方案：记录 + 允许 + 可追溯
  ├─ 系统展示警告：⚠️ "这是规划草案，非共识产物"
  ├─ 用户确认："我已知晓风险"
  ├─ 系统记录：
  │  ├─ 哪个用户、何时、使用了哪份草案
  │  ├─ 草案中的异议内容是什么
  │  └─ 进入 codegen 时的所有输入快照
  ├─ Codegen 执行：正常生成代码
  ├─ 代码生成过程中的所有决策和输入也被记录
  └─ 如果问题追溯：logs 中清晰显示"这是基于未共识的草案"
```

**不采用的方案**：
- ❌ 硬性阻止（拒绝启动 codegen）
- ❌ 自动降级为严格审查

**采用的方案**：
- ✅ 显式警告 + 用户确认
- ✅ 详细的日志记录（输入、决策、追溯）

**代码影响**：
- 在 `codegenAgent.mjs` 前添加检查：是规划案还是草案
- 如果是草案，显示警告并要求用户确认
- 记录确认信息和时间戳到 task metadata 和 logs

**相关文件**：`src/agents/codegenAgent.mjs` (L1+), `src/core/accept.mjs` (gate 检查)

---

## 四、小会的三角色互动模式

### ✅ 决策4：群聊式小会 + 群体判断

**原文**：
> 敏捷教练负责记录、旁听、控制会议节奏，不让询问的 AI "暴走"，其实呈现的形式很简单，就是群聊——提示用户现在在开小会了，当前参会者都有谁，然后按照 AI 发言顺序，让 AI 们提问，其实此时可以借鉴 之前的 AI 自讨论的形式，每个 AI 的输入都带上前面 用户的回答、前面几个 AI 的问题，判断自己的问题是否要改变

**含义**：

小会的流程和形式：

```
【小会开启】
系统提示：
  "📞 规划讨论小会开始"
  "参会者：敏捷教练、ProductPlanner、SystemDesigner、SeniorDeveloper、TestPlanner、RiskPlanner（共 6 者）"
  "当前需要澄清的问题："
    - 系统是否要与现有用户系统绑定？
    - 数据迁移是否在 scope 内？
    - API 权限是细粒度还是粗粒度？

【第一轮提问】
AI #1 (ProductPlanner) 发言：
  输入：
    - 前两轮的共识
    - 自己之前的结论
    - 待澄清问题列表
  判断：需要深化哪个问题，或者"嗯其实我的问题已经被其他角色问了"
  输出："系统是否要与现有用户系统绑定？这很关键。"

用户回答：
  "是的，需要绑定。而且还要支持现有 50 万用户平滑迁移。"

系统记录：
  user_answer_1: "是的，需要绑定。而且还要支持现有 50 万用户平滑迁移。"

【第二轮提问】
AI #2 (SystemDesigner) 发言：
  输入：
    - 前两轮的共识
    - 用户对第一个问题的回答
    - ProductPlanner 刚才的问题
    - 自己之前的结论
  判断："哦，绑定 50 万现有用户，这改变了我的设计复杂度评估"
  输出："那数据迁移是否在这次 scope 内？能否使用现有的数据库存储？"

用户回答：
  "数据迁移暂时不在这次 scope 内，我们用现有数据库。"

...（以此类推，每个 AI 轮流发言）

【小会结束】
系统总结：
  "澄清小会已结束，共澄清 3 个问题，所有角色都已发言。"
```

**关键设计点**：
1. **群聊式呈现**：用户感知到的是"一个小会进行中"，而不是"系统在做某个计算"
2. **AI 们能看到彼此的问题**：后发言的 AI 可以判断"这个问题我还需要问吗？"或"我需要更细化的问题"
3. **动态取消冗余问题**：如果 SystemDesigner 看到 ProductPlanner 已经问了"系统绑定"，就可以略过，改为问"数据库选型"
4. **用户逐个回答**：确保每个回答都被清晰地记录和理解

**代码影响**：
- 小会逻辑从 `runClarificationMiniMeeting()` 升级为 `runPlanningClarificationMeeting()`
- 需要实现"AI 看到前面的问题后，决定自己是否调整问题"的逻辑
- 记录结构改为"Q1: question, A1: answer, Q2: question, A2: answer, ..."
- 用户 UX 改为展示当前"轮数"和"即将提问的角色"

**相关文件**：`src/cli/commands/plan.mjs` (L111+) 的 `runClarificationMiniMeeting()` 需要重写

---

## 五、版本迭代的起点判断

### ✅ 决策5：敏捷教练进行"用户意图判断"

**原文**：
> 看用户是否上传了规划案或者规划草案，而且用户在使用语言描述需求的时候肯定会带上描述，那么此时让敏捷教练来判断用户意图就可以了，判断不出来就直接问用户"我看到你上传了 xxxx 文件，看着是一份规划案、规划草案，你是想基于这份文件来细化你的续期，还是其他目的"

**含义**：

当用户新增需求并可能上传历史规划产物时的流程：

```
用户输入：
  "我想基于之前的权限系统规划，现在需要添加审计日志功能"
  [并上传：planning.ai.json]

敏捷教练的判断逻辑：
  ├─ 检测到上传了文件
  ├─ 识别文件类型（规划案 vs 草案）
  ├─ 阅读用户的文字描述："基于之前...现在需要添加..."
  ├─ 判断用户意图：
  │  ├─ "细化之前的规划" → 加载旧规划作为上下文背景
  │  ├─ "创建新规划但参考旧规划" → 新规划进程，旧规划作为参考
  │  └─ "不确定" → 向用户确认
  └─ 如果判断不出来，主动问：
      "我看到你上传了一份权限系统的规划案。
       你是想：
         1️⃣ 基于这份规划来细化审计日志的功能需求？
         2️⃣ 针对审计日志开启一个全新的规划，但参考权限系统的设计思路？
         3️⃣ 其他？"
```

**为什么要加这一步**：
- 之前假设"用户初始输入时信息已准确"（所以没有澄清）
- 现在用户可能上传历史产物，意图变得模糊
- 敏捷教练主动做"关键目的澄清"，确保后续讨论方向正确

**代码影响**：
- 在 `PlanningAgent.step()` 前或初期添加"用户意图判断"
- 可能需要一个新的 `AgileCouchCoachIntentCheck()` 或类似的函数
- 加载 transcript 时检查是否有上传的文件
- 根据意图判断是否"继承"旧规划的共识还是"全新开始"

**相关文件**：`src/agents/planningAgent.mjs` (L1+), 可能需要新增 `src/planning/intentCheck.mjs`

---

## 六、用户参与度设计

### ✅ 决策6：用户全程参与 - "Battle" 模式

**原文**：
> 关于后台自动执行，你希望用户参与进每一轮的讨论中吗？跟每一位需要澄清问题的 AI 做 battle？
> 
> （我的理解）我觉得复杂度不高，对用户来说他不在乎感知复杂度，他在乎的是产出物的质量

**含义**：
```
设计哲学：用户全程参与讨论，确保产出质量

用户旅程：
  ① 提需求 → ② 看 Round 1 讨论进展 → ③ 看 Round 2 讨论进展
  ④ 进入小会，逐个回答 AI 的澄清问题（"做 battle"）
  ⑤ 看 Round 3 讨论进展 → ⑥ 看规划案/草案 → ⑦ 确认或迭代

不采用的设计：
  ❌ "后台悄悄执行，最后直接给用户一个规划案"
  
原因：
  - 用户需要在关键节点（小会）直接参与
  - 用户看到 AI 的推理过程，可以更好地理解和信任结果
  - 对产出质量的关键决策点（澄清），用户必须在场
```

**UX 体验**：
- 用户看到每一轮讨论的进度（不是黑盒）
- 小会时用户成为"主角"，而不是被动接收
- 用户可以在任何时刻暂停或调整方向

**代码影响**：
- REPL 或 UI 中需要实时展示讨论进度
- 小会阶段用户必须等待和回答（不能跳过）
- 无"跳过小会"或"自动同意"的选项

**相关文件**：`src/cli/repl.mjs` (display 逻辑), `src/cli/commands/plan.mjs` (小会流程)

---

## 七、产物的最终定义

### ✅ 决策7：产物的严格分化

基于所有决策，最终产物的定义：

| 产物 | 何时生成 | 格式 | 能否用于 Codegen | 内容 |
|------|--------|------|----------------|------|
| **规划案** `planning.ai.json` | Round 1 全同意 OR Round 3 后全同意 | JSON | ✅ 可以 | { why, what, requirements, draft_files, acceptance, scope, non_goals, test_plan, ... } |
| **规划草案** `planning.draft.md` | Round 3 后未全同意 | Markdown | ❌ 不能（需警告+确认）| 需求原文 + 讨论记录 + 各角色立场 + **未达成共识部分** ⚠️ |
| **小会记录** `planning.clarification.jsonl` | 小会完成后 | JSONL | - | 每行 { ts, ai_role, question/answer, user_input, ... } |
| **讨论版本快照** `versions/v{n}/` | 每个循环后 | 目录 | - | 该版本的所有产物 |

---

## 八、后续实现优先级

### 立即执行（Phase 1 - M11-3）

1. ✅ **快速路径**：Round 1 全同意 → 直接产出规划案，无 Round 2/3
2. ✅ **Round 3 输入精化**：构建精确的 payload 结构
3. ✅ **小会群聊式实现**：重写 `runClarificationMiniMeeting()`，支持 AI 看到前面的问题
4. ✅ **用户意图判断**：敏捷教练主动澄清用户的新规划意图
5. ✅ **草案风险记录**：如果用户用草案做 codegen，记录完整追溯链

### 后续优化（Phase 2 - M12）

6. 版本管理 UI（查看版本、对比、回滚）
7. 讨论进度的实时展示
8. "动态取消冗余问题"的 AI 智能判断

### 未来扩展（Phase 3+）

9. 人类专家介入机制
10. 规划案质量评分

---

## 九、文档更新需求

基于上述决策，需要更新的文档：

- [ ] `PLANNING-WORKSHOP-CONSENSUS-MODEL-2025-11-18.md` - 加入"快速路径"和"Round 3 精确输入"
- [ ] `PLANNING-STAGE-USER-JOURNEY-2025-11-18.md` - 更新小会流程和用户参与模式
- [ ] 新增 `PLANNING-IMPLEMENTATION-SPEC-2025-11-18.md` - 代码实现规范

---

**下一步行动**：
1. 确认上述 7 个决策无异议
2. 开始编写实现规范（PLANNING-IMPLEMENTATION-SPEC）
3. 开始代码改动

