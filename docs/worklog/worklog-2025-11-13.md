# Worklog — 2025-11-13

目标：落地 OpenSpec 强制与计划生成、评测 Gate 覆盖配置、自动日志归档雏形、模板补全与 doctor 扩展。

本次改动（摘要）
- 模板：新增 OpenSpec 与 Promptfoo 模板
  - `templates/.ai-tools-chain/openspec/spec.yaml`
  - `templates/.ai-tools-chain/openspec/schema.yaml`
  - `templates/.ai-tools-chain/promptfoo/promptfooconfig.yaml`
- 配置：为 Gate/Override 增加默认键位
  - `templates/.ai-tools-chain/config/toolchain.conf`
    - `[eval] allow_gate_override = false`
    - `[confirm] override_phrase = 确认合入`
- CLI：新增 OpenSpec 相关命令
  - `ai-tools spec:scaffold`：生成/补全 openspec 模板
  - `ai-tools spec:lint`：最小校验（meta.id/title 与 targets）
  - `ai-tools spec:plan`：从 OpenSpec 生成最近任务的 plan，并快照 spec 至任务目录
- REPL：/plan 强制从 OpenSpec 生成
  - 快照 `openspec/spec.yaml` 至 `tasks/<id>/openspec/`
  - 将 guardrails/acceptance 合并至 `meta.json`
- Gate：在 `/accept` 提交前检查最新 `eval-report.json`
  - 默认失败阻断；若 `[eval].allow_gate_override=true`，则需输入 `[confirm].override_phrase` 强确认才允许提交
- 归档：自动归档（7 天）雏形
  - 在 REPL 进入、`/eval` 结束、`/accept` 成功后触发检查
  - 打包任务目录下日志类文件（`transcript.jsonl`、`eval-*.log`）至 `.ai-tools-chain/archives/<taskid>.tar.gz` 并清理原日志
- doctor：增加 openspec 存在性检查
- init：在输出列表中包含 openspec/promptfoo 模板

未完成 / 后续计划
- 将 `/codegen`、`/review`、第二意见切换至 `invokeRole` + `models.conf`（当前仍用 providers demo）
- Promptfoo 结果解析入 gate（当前 gate 基于步骤是否 failed）
- OpenSpec 更严格的 lint（schema 校验）
- 归档范围/策略可配置化（当前仅日志类文件）

验证建议
- `ai-tools init -y` 后编辑 `.ai-tools-chain/openspec/spec.yaml`
- 运行 `ai-tools spec:lint`；进入 `ai-tools repl`，执行 `/plan` 观察 plan 与 meta 合并
- 执行 `/eval`，制造失败场景，尝试 `/accept`：应被阻断；将 `[eval].allow_gate_override=true` 后重试并输入“确认合入”

影响范围
- CLI 入口与 REPL 增强；新模板引入；默认配置新增键。
 现有行为向后兼容（OpenSpec 缺失时会引导 scaffold，`/plan` 不再生成空模板而是要求 OpenSpec）。

